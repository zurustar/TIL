
PostgreSQLを前提としたRDBMSの勉強

# データベース




# RDBMS



# PostgreSQL

追記型アーキテクチャにより高速に動作。

でも追記型なので更新、削除でゴミが残る。このゴミをきれいにする掃除(VACUUMという)の実行が必要。

## ファイル



## メモリ

| 種別 | 和名 | 英名 | 説明 |
| --- | --- | --- | --- |
| 共有メモリ | 共有バッファ | shared_buffers | テーブルやインデックスのデータをキャッシュする領域 |
| 共有メモリ | WALバッファ | wal_buffers | ディスクに書き込まれていないトランザクションログ(WAL: Write Ahead Log)をキャッシュする領域 |
| 共有メモリ | 空き領域マップ | Free Space Map | テーブル上の利用可能な領域を指し示す情報を扱う領域 |
| 共有メモリ | 可視性マップ | Visibility Map | テーブルのデータが可視であるか否かを管理する情報を扱う領域 |
| プロセスメモリ | 作業メモリ | work_mem | クエリ実行時に行われる並び替えと、ハッシュテーブルの操作に使われる領域。ひとつのクエリ内でこれら操作が複数回実行される場合はその処理毎に設定した領域が確保される。 |
| プロセスメモリ | メンテナンス用作業メモリ | maintenance_work_mem | バキューム、インデックス作成、外部キー追加などのデータベースのメンテナンス作業の操作で使用する領域 |
| プロセスメモリ | 一時バッファ | temp_buffers | バックエンドプロセス毎に作成される一時テーブルにアクセスするときに用いられるメモリ領域 |

## PostgreSQLを構成するプロセス一覧

| プロセス名 | 役割 |
| --- | --- |
| マスタープロセス | 最初に起動されるプロセス |
| ライタ | 共有バッファの内容をデータファイルに書き出す |
| WALライタ | WALバッファの内容をWALファイルに書き出す |
| チェックポインタ | すべてのダーティページをデータファイルに書き出す |
| 自動バキュームランチャ | 設定に従って自動バキューム処理を行う |
| 統計情報コレクタ | データベースの活動状況に関する統計情報を収集 |
| バックエンド | クライアントからの接続要求に対して起動されクエリを処理する |
| バックグラウンドワーカ | ロジカルレプリケーション用のワーカ |
| パラレルワーカ | パラレススキャン実行時に起動される |



## メモリ構成

# SQL

RDBMSを操作するために標準化された言語。



## DDL

### CREATE

### DELETE

### ALTER



## DML

RDBMSのCRUDに対応する命令として、以下がある。

|     | CRUDでいうと | SQLの命令 | できること       |
| --- | ------------ | --------- | ---------------- |
|  C  | create       | INSERT    | 新規データの挿入 |
|  R  | read         | SELECT    | データの検索     |
|  U  | update       | UPDATE    | 既存データの更新 |
|  D  | delete       | DELETE    | データの削除     |


### WHERE句

データ追加以外では条件指定がある(何を消す？・何を探す？・何を更新する？）ので、先に条件指定に用いるWHERE句について説明する。

#### 値の比較 =, <, >, <=, >=, !=, <>, NOT

#### 範囲での比較 BETWEEN

#### 値の有無 IN

#### 部分文字列 LIKE

### INSERT

### DELETE

条件に一致したデータを削除する。条件を指定しなかった場合、指定されたテーブルからすべてのデータが削除されるので要注意。

### UPDATE

### SELECT

ひとつ以上の表をこねくり回して表を作る、とイメージするとわかりやすいかもしれない。

#### サブクエリ

以降いろいろ説明を書くが、いずれもテーブル名を記載できる場所には、SELECT文を書くことができる。
SELECTはテーブルからテーブルを生み出すものであるから。




#### 集約


##### GROUP BY


##### HAVING



#### 結合 UNIONとJOIN

ふたつのテーブルをくっつける方法は２種類。
縦方向にくっつける」「UNION」と横方向にくっつける「JOIN」がある。
JOINにはさらに
「(INNER) JOIN」「LEFT (OUTER) JOIN」「RIGHT (OUTER) JOIN」「CROSS JOIN」
という結合方法が異なる４種類がある。

#### UNION

UNIONするふたつの表は列数が同一である必要あり。

|  X  |  Y  |  Z  |
| --- | --- | --- |
|  1  |  3  |  5  |
|  2  |  4  |  6  |

と

|  X  |  Y  |  Z  |
| --- | --- | --- |
|  7  |  9  |  b  |
|  8  |  a  |  c  |

を UNIONすると

|  X  |  Y  |  Z  |
| --- | --- | --- |
|  1  |  3  |  5  |
|  2  |  4  |  6  |
|  7  |  9  |  b  |
|  8  |  a  |  c  |

になる。SQLだと、

SELECT table1 UNION table2;

みたいに書く。

#### CROSS JOIN

#### 内部結合 (INNER) JOIN

左側 JOIN 右側 ON 値

と結合すると、その双方に含まれるものだけが選ばれる。


#### 左外部結合 LEFT (OUTER) JOIN

#### 右外部結合 RIGHT (OUTER) JOIN

#### 順番の指定 ORDER BY

## DCL

